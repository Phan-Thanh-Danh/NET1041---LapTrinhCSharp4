@model Lab2ModelBinding.Models.Order
@using Newtonsoft.Json
@{
    ViewData["Title"] = "Tạo đơn hàng mới";
}

<div>
    <header>
        <h2>Tạo đơn hàng mới</h2>
        <a asp-action="Filter" class="button">Xem danh sách đơn hàng</a>
    </header>

    <form asp-action="Create" method="post" id="orderForm">
        
        <h3>Thông tin đơn hàng</h3>
        <div>
            <label asp-for="CustomerName">Tên khách hàng</label>
            <input asp-for="CustomerName" placeholder="Nhập tên khách hàng..." />
            <span asp-validation-for="CustomerName"></span>
        </div>
        <div>
            <label asp-for="Status">Trạng thái</label>
            <select asp-for="Status">
                <option value="Pending">Đang chờ xử lý</option>
                <option value="Completed">Hoàn thành</option>
                <option value="Cancelled">Đã hủy</option>
            </select>
            <span asp-validation-for="Status"></span>
        </div>

        <h3>Chi tiết đơn hàng</h3>
        <button type="button" id="add-item-btn">Thêm sản phẩm</button>
        
        <table>
            <thead>
                <tr>
                    <th>Sản phẩm</th>
                    <th>Số lượng</th>
                    <th>Đơn giá</th>
                    <th>Thành tiền</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="order-details-body">
                <!-- Dynamic rows will be here -->
            </tbody>
            <tfoot id="order-footer" style="display: none;">
                <tr>
                    <td colspan="3" style="text-align: right;"><strong>Tổng cộng:</strong></td>
                    <td id="total-amount">0.00</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>

        <div>
            <button type="submit">Tạo đơn hàng</button>
            <a asp-action="Filter" class="button">Hủy bỏ</a>
        </div>
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        const products = @Html.Raw(JsonConvert.SerializeObject(ViewBag.Products));
        let itemIndex = 0;

        document.getElementById('add-item-btn').addEventListener('click', function () {
            const tableBody = document.getElementById('order-details-body');
            const row = document.createElement('tr');
            const rowId = `row-${itemIndex}`;

            let options = '<option value="">Chọn sản phẩm</option>';
            products.forEach(p => {
                options += `<option value="${p.Name}" data-price="${p.Price}">${p.Name}</option>`;
            });

            row.id = rowId;
            row.innerHTML = `
                <td>
                    <select name="OrderDetails[${itemIndex}].ProductName" required onchange="updatePrice('${rowId}')">
                        ${options}
                    </select>
                </td>
                <td>
                    <input name="OrderDetails[${itemIndex}].Quantity" type="number" value="1" min="1" required onchange="calculateRowTotal('${rowId}')" />
                </td>
                <td>
                    <input name="OrderDetails[${itemIndex}].Price" type="number" step="0.01" value="0" required readonly onchange="calculateRowTotal('${rowId}')" />
                </td>
                <td>
                    <span class="row-total">0.00</span>
                </td>
                <td>
                    <button type="button" class="remove-btn" onclick="removeRow('${rowId}')">Xóa</button>
                </td>
            `;

            tableBody.appendChild(row);
            document.getElementById('order-footer').style.display = 'table-footer-group';
            itemIndex++;
            calculateTotal();
        });

        function updatePrice(rowId) {
            const row = document.getElementById(rowId);
            const select = row.querySelector('select');
            const priceInput = row.querySelector('input[name*="Price"]');
            const selectedOption = select.options[select.selectedIndex];
            const price = selectedOption.dataset.price || 0;

            priceInput.value = price;
            calculateRowTotal(rowId);
        }

        function calculateRowTotal(rowId) {
            const row = document.getElementById(rowId);
            const quantity = parseFloat(row.querySelector('input[name*="Quantity"]').value) || 0;
            const price = parseFloat(row.querySelector('input[name*="Price"]').value) || 0;
            const total = quantity * price;

            row.querySelector('.row-total').textContent = total.toFixed(2);
            calculateTotal();
        }

        function calculateTotal() {
            let totalAmount = 0;
            document.querySelectorAll('.row-total').forEach(total => {
                totalAmount += parseFloat(total.textContent) || 0;
            });
            document.getElementById('total-amount').textContent = totalAmount.toFixed(2);
        }

        function removeRow(rowId) {
            document.getElementById(rowId).remove();
            reIndexRows();
            calculateTotal();

            if (document.querySelectorAll('#order-details-body tr').length === 0) {
                document.getElementById('order-footer').style.display = 'none';
            }
        }

        function reIndexRows() {
            const rows = document.querySelectorAll('#order-details-body tr');
            itemIndex = 0;
            rows.forEach(row => {
                row.id = `row-${itemIndex}`;
                row.querySelectorAll('input, select').forEach(input => {
                    input.name = input.name.replace(/\[\d+\]/, `[${itemIndex}]`);
                });
                row.querySelector('select').onchange = () => updatePrice(row.id);
                row.querySelector('input[name*="Quantity"]').onchange = () => calculateRowTotal(row.id);
                row.querySelector('.remove-btn').onclick = () => removeRow(row.id);
                itemIndex++;
            });
        }

        window.onload = function () {
            document.getElementById('add-item-btn').click();
        };
    </script>
}